version: 2.1

executors:
  nodejs:
    docker:
      - image: circleci/node:11.11
    working_directory: ~/repo

commands:
  install-deps:
    steps:
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile --production=false
  restore-caches:
    steps:
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - restore_cache:
          name: Restore node_modules Cache
          keys:
            - dependencies-{{ checksum "package.json" }}
  save-caches:
    steps:
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - save_cache:
          name: Save node_modules Cache
          paths:
            - node_modules
          key: dependencies-{{ checksum "package.json" }}
  build-project:
    steps:
      - run:
          name: Build Next.js Project
          command: yarn build
  deploy-to-now:
    steps:
      - run:
          name: Deploy to production
          command: |
            if [ "$WEBHOOK_TRIGGER" == "true" ]; then
              npx now --target production -e NODE_ENV=production --token=$NOW_TOKEN
              WEBHOOK_TRIGGER=false
            fi

jobs:
  build:
    executor: nodejs
    steps:
      - checkout
      - restore-caches
      - install-deps
      - save-caches
      - build-project
    environment:
      WEBHOOK_TRIGGER: false
  nowDeploy:
    executor: nodejs
    steps:
      - checkout
      - restore-caches
      - deploy-to-now

workflows:
  build-deploy:
    jobs:
      - build
      - nowDeploy:
          requires:
            - build
